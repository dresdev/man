!function(){const e=e=>document.querySelector(e),t=e=>Array.from(document.querySelectorAll(e)),r=(t,r,n,s)=>{const a="string"==typeof t?e(t):t;return a&&a.addEventListener&&a.addEventListener(r,n,s||{passive:!0}),!!a};var n;!window.meta&&window.MANGA_META&&(window.meta=window.MANGA_META),!window.chapters&&window.MANGA_CHAPTERS&&(window.chapters=window.MANGA_CHAPTERS),n=function(){if(!window.meta||!window.chapters)return;const n="mreader:v10";let s=window.meta?.slug;s||(console.warn("No se encontró slug en window.meta, usando título como fallback"),s=window.meta?.title?.toLowerCase().replace(/[^a-z0-9]+/g,"-")||"manga");const a={prefs:`${n}:${s}:prefs`,seen:`${n}:${s}:seen`},o=(e,t)=>localStorage.setItem(e,JSON.stringify(t)),i=(e,t)=>{try{return JSON.parse(localStorage.getItem(e))??t}catch{return t}},c="mreader:favorites",l=e=>{try{return JSON.parse(localStorage.getItem(e))??[]}catch{return[]}},d=(e,t)=>localStorage.setItem(e,JSON.stringify(t)),u=(e,t,r="slug")=>{const n=l(e).filter((e=>e[r]!==t[r]));return n.unshift(t),d(e,n),n},g=(e,t,r="slug")=>{const n=l(e).filter((e=>e[r]!==t));return d(e,n),n},p="mreader:chaptersReversed",h={prefs:i(a.prefs,{mode:"scroll",dir:"rtl",fit:"width",compact:!1}),current:{index:-1,chapter:null,images:[],page:0},io:null,lazyQueue:[],lazyBusy:!1,_lastAppliedIdx:null,fitOverride:{},seeking:!1,seen:i(a.seen,{}),chaptersReversed:((e,t=!1)=>{try{const r=localStorage.getItem(e);return null===r?t:"true"===r||"false"===r?"true"===r:!!JSON.parse(r)}catch{return t}})(p,!1)},m=e("#directionSettings");m&&(m.style.display="paged"===h.prefs.mode?"":"none"),r("#compactMode","change",(r=>{I("compact",r.target.checked),h.current.chapter&&(e("#reader").classList.toggle("compact",r.target.checked),t("#readerScroll .img-container img").forEach((e=>{e.style.minHeight=r.target.checked?"20vh":"30vh"})))}));const f=()=>h.current.chapter?h.current.chapter.number??`${h.current.index+1}`:null;function y(){const t=e("#readerBody"),r=e("#readerScroll");if(!t||!r)return 0;const n=t.scrollTop+t.clientHeight/2,s=Array.from(r.querySelectorAll("img"));if(!s.length)return 0;let a=0,o=1/0;for(let e=0;e<s.length;e++){const t=s[e].offsetTop+s[e].offsetHeight/2,r=Math.abs(t-n);r<o&&(o=r,a=e)}return a}const w=()=>"paged"===h.prefs.mode?h.current.page||0:y();function v(){const t=e("#favBtn");if(l(c).some((e=>e.slug===s))){if(g(c,s,"slug"),t){t.classList.remove("active"),t.setAttribute("aria-pressed","false");const e=t.querySelector(".heart");e.classList.remove("ri-heart-3-fill"),e.classList.add("ri-heart-3-line")}}else if(u(c,{slug:s,title:window.meta?.title||"",cover:window.meta?.cover||"",genres:window.meta?.genres||[],addedAt:Date.now()}),t){t.classList.add("active"),t.setAttribute("aria-pressed","true");const e=t.querySelector(".heart");e.classList.remove("ri-heart-3-line"),e.classList.add("ri-heart-3-fill")}}function x(){const n=e("#chaptersTable tbody");if(!n)return;n.innerHTML="";const s=window.chapters||[];(h.chaptersReversed?[...s].reverse():s).forEach(((e,t)=>{const r=h.chaptersReversed?s.length-1-t:t,a=e.number??`${r+1}`,o=!(!h.seen||!h.seen[a]),i=document.createElement("tr");i.className="episode-row"+(o?" is-seen":""),i.dataset.idx=String(r),i.innerHTML=`\n          <td class="episode-cell">\n            <span class="episode-title" style="font-size:14px">${e.title||"Capítulo "+a}</span>\n          </td>\n          <td class="episode-seen">\n            <div class="seen-wrap">\n              <input type="checkbox" class="seen-checkbox" aria-label="Marcar como visto" data-idx="${r}" ${o?"checked":""} />\n            </div>\n          </td>`,n.appendChild(i)})),t("#chaptersTable tbody tr.episode-row").forEach((t=>{r(t,"click",(()=>async function(t){const r=window.chapters[t];if(!r)return;h.current.index=t,h.current.chapter=r,h.current.images=r.images||[],h.current.page=0,h._scrollTargetIndex=null,h._lastAppliedIdx=null;const n=r.number??`${t+1}`;e("#readerTitle")&&(e("#readerTitle").textContent=r.title||"Capítulo "+n);const s=e("#reader");if(s&&(s.classList.add("active"),s.setAttribute("aria-hidden","false")),document.body.style.overflow="hidden",await L(),"scroll"===h.prefs.mode){const e=h.current.page||0,t=2,r=Math.max(0,e-t),n=Math.min(h.current.images.length-1,e+t);await Promise.all(h.current.images.slice(r,n+1).map((e=>new Promise((t=>{const r=new Image;r.onload=t,r.onerror=t,r.src=e})))));const s=document.querySelector(`#readerScroll img[data-idx="${e}"]`);s&&s.scrollIntoView({block:"start"})}"undefined"!=typeof loadingIndicator&&loadingIndicator&&"function"==typeof loadingIndicator.remove&&loadingIndicator.remove()}(+t.dataset.idx)))})),t('#chaptersTable input[type="checkbox"][data-idx]').forEach((e=>{r(e,"click",(e=>e.stopPropagation())),r(e,"change",(()=>{const t=+e.dataset.idx,r=window.chapters[t]?.number??`${t+1}`;h.seen=h.seen||{},h.seen[r]=e.checked,o(a.seen,h.seen);const n=e.closest("tr");n&&n.classList.toggle("is-seen",e.checked)}))})),function(){const t=e("#btnReverseOrder");if(!t)return;const r=t.querySelector("i");h.chaptersReversed?(r&&(r.className="ri-sort-asc"),t.innerHTML='<i class="ri-sort-asc"></i> Orden original',t.title="Volver al orden original"):(r&&(r.className="ri-sort-desc"),t.innerHTML='<i class="ri-sort-desc"></i> Invertir orden',t.title="Invertir orden de capítulos")}()}function k(e){const t=f();return t?(h.fitOverride[t]||{})[e]??null:null}function b(t){null!=h._lastAppliedIdx&&h._lastAppliedIdx!==t&&function(t){if("scroll"===h.prefs.mode){const r=e("#readerScroll");if(!r)return;const n=r.querySelector(`img[data-idx="${t}"]`);if(!n)return;n.style.maxWidth="",n.style.width="",n.style.maxHeight="",n.style.height=""}else{const t=e("#pageImg");if(!t)return;t.style.maxWidth="",t.style.width="",t.style.maxHeight="",t.style.height=""}}(h._lastAppliedIdx),h._lastAppliedIdx=t;const r=k(t);if(function(t){const r=e("#fitModeBadge");r&&(r.textContent="width"===t?"Ancho":"height"===t?"Alto":"Auto")}(r),"scroll"===h.prefs.mode){const n=e("#readerScroll");if(!n)return;const s=n.querySelector(`img[data-idx="${t}"]`);if(!s)return;"width"===r?(s.style.width="100%",s.style.maxWidth="none",s.style.height="auto",s.style.maxHeight=""):"height"===r?(s.style.width="auto",s.style.maxWidth="none",s.style.height="auto",s.style.maxHeight="85vh"):(s.style.maxWidth="",s.style.width="",s.style.height="",s.style.maxHeight="")}else{const t=e("#pageImg");if(!t)return;"width"===r?(t.style.width="100%",t.style.maxWidth="none",t.style.height="auto",t.style.maxHeight=""):"height"===r?(t.style.width="auto",t.style.maxWidth="none",t.style.height="auto",t.style.maxHeight="calc(100vh - 56px)"):(t.style.maxWidth="",t.style.width="",t.style.height="",t.style.maxHeight="")}}function S(){[["#modeScroll","scroll"===h.prefs.mode],["#modePaged","paged"===h.prefs.mode],["#dirRTL","rtl"===h.prefs.dir],["#dirLTR","ltr"===h.prefs.dir],["#fitContain","contain"===h.prefs.fit],["#fitWidth","width"===h.prefs.fit],["#fitNone","none"===h.prefs.fit]].forEach((([t,r])=>{const n=e(t);n&&n.classList.toggle("active",r)}));const t=e("#compactMode");t&&(t.checked=h.prefs.compact)}function I(t,r){if("mode"===t&&r!==h.prefs.mode){h.current.chapter&&("scroll"===h.prefs.mode?h._scrollTargetIndex=y():h._scrollTargetIndex=h.current.page||0);const t=e("#directionSettings");t&&(t.style.display="paged"===r?"":"none")}h.prefs[t]=r,o(a.prefs,h.prefs),S(),h.current.chapter&&L(!0)}function L(t=!1){const r="scroll"===h.prefs.mode,n=e("#readerBody"),s=e("#readerScroll"),a=e("#readerPaged");if(!n)return;h.io&&(h.io.disconnect(),h.io=null),h.lazyQueue=[],h.lazyBusy=!1,n.onscroll=null;const o=e("#pageImg");if(o&&(o.onclick=null),h._lastAppliedIdx=null,s&&(s.style.display=r?"":"none"),a&&a.classList.toggle("active",!r),r&&s){s.innerHTML="",e("#reader").classList.toggle("compact",h.prefs.compact),n.scrollTop=0,h.current.images.forEach(((e,t)=>{const r=document.createElement("div");r.className="img-container";const n=document.createElement("img");n.setAttribute("loading","lazy"),n.dataset.src=e,n.dataset.idx=t,n.alt="Página",n.style.minHeight=h.prefs.compact?"20vh":"30vh",n.addEventListener("click",E);const a=document.createElement("div");a.className="img-loader",r.appendChild(n),r.appendChild(a),s.appendChild(r)})),function(t){const r=e("#readerBody");if(!("IntersectionObserver"in window)||!r)return void t.querySelectorAll("img[data-src]").forEach(T);let n=null;const s=()=>{clearTimeout(n),n=setTimeout(A,16)};h.io=new IntersectionObserver((e=>{let t=!1;e.forEach((e=>{const n=e.target;e.isIntersecting?n.dataset.src&&!n.dataset.enqueued&&(n.dataset.enqueued="1",h.lastScrollTop>r.scrollTop?h.lazyQueue.unshift(n):h.lazyQueue.push(n),t=!0):n.dataset.src&&n.src})),t&&s()}),{root:r,rootMargin:"200% 0px 200% 0px",threshold:0}),t.querySelectorAll("img[data-src]").forEach((e=>h.io.observe(e)))}(s),M();let r=0;if(t&&null!=h._scrollTargetIndex&&(r=Math.max(0,Math.min(h.current.images.length-1,h._scrollTargetIndex))),r>0||t){const e=s.querySelectorAll("img"),t=e[r];t&&(t.scrollIntoView({block:"start"}),T(t),e[r-1]&&T(e[r-1]),e[r+1]&&T(e[r+1]),requestIdleCallback((()=>{const n=Date.now();!function s(a){if(!(a>=e.length)){for(let n=0;n<3&&a+n<e.length;n++){const s=e[a+n];s&&s.dataset.src&&!s.dataset.enqueued&&s!==t&&s!==e[r-1]&&s!==e[r+1]&&T(s)}setTimeout((()=>{Date.now()-n>1e4?requestIdleCallback((()=>s(a+3))):s(a+3)}),100)}}(0)}),{timeout:1e3}))}b(w()),n.onscroll=C,C()}else o&&(M(),t&&null!=h._scrollTargetIndex&&(h.current.page=Math.max(0,Math.min(h.current.images.length-1,h._scrollTargetIndex))),H(),o.onclick=E,q(h.current.page));$("render"),S()}function A(){if(h.lazyBusy)return;h.lazyBusy=!0;let e=0,t=null;const r=()=>{if(0===e&&0===h.lazyQueue.length)return void(h.lazyBusy=!1);if(e>=4)return;const n=h.lazyQueue.shift();if(!n)return void(e>0?(clearTimeout(t),t=setTimeout((()=>r()),100)):h.lazyBusy=!1);e++;const s=()=>{e--,n.onload=null,n.onerror=null,r()};if(n.dataset&&n.dataset.src){const e=new Image;e.onload=()=>{n.src=n.dataset.src,n.removeAttribute("data-src"),s()},e.onerror=()=>{console.error("Error cargando imagen:",n.dataset.src),s()},e.src=n.dataset.src}else s();r()};r()}function T(e){e&&e.dataset&&e.dataset.src&&(e.src=e.dataset.src,e.removeAttribute("data-src"))}function M(){const r=h.prefs.fit,n=e(".reader-head"),s=n&&"none"===n.style.display;if("scroll"===h.prefs.mode)t("#readerScroll img").forEach((e=>{e.style.cssText="",e.style.width="100%",e.style.maxWidth="100%",e.style.height="auto",e.style.maxHeight="none"}));else{const t=e("#pageImg");if(!t)return;t.style.cssText="";const n=s?"100vw":"calc(100vw - 16px)";t.style.cssText="width"===r||"height"===r?`\n            width: auto !important;\n            height: auto !important;\n            max-width: ${n} !important;\n          `:`\n            width: auto !important;\n            height: auto !important;\n            max-width: ${n} !important;\n            max-height: none !important;\n            object-fit: none !important;\n          `}}function E(){const t=e(".reader-head"),r=e("#readerFoot"),n=e("#scrollPageIndicator");if(!t||!r)return;const s="none"!==t.style.display||"none"!==r.style.display;t.style.display=s?"none":"",r.style.display=s?"none":"",n&&"scroll"===h.prefs.mode&&(n.style.display=s?"none":"block");const a=e("#pageImg");a&&(a.style.maxWidth=s?"100vw":"calc(100vw - 16px)")}function C(){const t=e("#readerBody");if(!t)return;h.lastScrollTop=t.scrollTop;const r=y();h._lastAppliedIdx!==r&&b(r),$("scroll")}function H(){const t=h.current.images.length,r=Math.max(0,Math.min(t-1,h.current.page)),n=e("#pageImg");n&&(n.src=h.current.images[r]),b(r),q(r),$("paged")}function q(e){const t=h.current.images||[];[e-1,e+1].forEach((e=>{e>=0&&e<t.length&&((new Image).src=t[e])}))}function N(){h.current.page<h.current.images.length-1&&(h.current.page++,H())}function P(){h.current.page>0&&(h.current.page--,H())}function R(t){const r=e("#footSlider");r&&(r.style.backgroundImage="linear-gradient(90deg,var(--accent,#8b5cf6),var(--accent2,#22d3ee))",r.style.backgroundSize=t+"% 100%",r.style.backgroundRepeat="no-repeat",r.style.backgroundColor="rgba(255,255,255,.10)")}function $(t){const r="scroll"===h.prefs.mode,n=h.current.images.length||1,s=w(),a=e("#pagedControls");if(e("#scrollPageIndicator"),a&&(a.style.display=r?"none":"flex"),!r){const r=e("#footSlider"),a=e("#footPageLabel");r&&(r.max=String(n),h.seeking&&"seek"===t||(r.value=String(s+1))),a&&(a.textContent=`${s+1}/${n}`);const o=s<=0,i=s>=n-1,c=e("#footPrevPage"),l=e("#footNextPage");c&&(c.disabled=o),l&&(l.disabled=i),R(Math.round((s+1)/Math.max(1,n)*100))}}async function _(t){const r=h.current.images.length,n=Math.max(0,Math.min(r-1,t));if("paged"===h.prefs.mode)h.current.page=n,H();else{h.seeking=!0,await function(t){return new Promise((r=>{const n=e("#readerScroll"),s=n?n.querySelectorAll("img"):null,a=s?s[t]:null;if(!a)return void r();if(T(a),s[t-1]&&T(s[t-1]),s[t+1]&&T(s[t+1]),a.complete&&a.naturalHeight>0||!a.dataset.src)return void r();const o=()=>{a.removeEventListener("load",o),a.removeEventListener("error",o),r()};a.addEventListener("load",o,{once:!0}),a.addEventListener("error",o,{once:!0})}))}(n);const t=e("#readerScroll"),r=t?t.querySelectorAll("img"):null;r&&r[n]&&r[n].scrollIntoView({block:"start"}),h.seeking=!1,$("seek")}}r("#tapLeft","click",(()=>{"rtl"===h.prefs.dir?N():P()})),r("#tapRight","click",(()=>{"rtl"===h.prefs.dir?P():N()})),r("#tapCenter","click",E),r("#footPrevPage","click",(()=>"paged"===h.prefs.mode?P():_(w()-1))),r("#footNextPage","click",(()=>"paged"===h.prefs.mode?N():_(w()+1)));const z=e("#footSlider");z&&(r(z,"pointerdown",(()=>{h.seeking=!0})),r(z,"pointerup",(()=>{h.seeking=!1})),r(z,"touchstart",(()=>{h.seeking=!0})),r(z,"touchend",(()=>{h.seeking=!1})),r(z,"mousedown",(()=>{h.seeking=!0})),r(z,"mouseup",(()=>{h.seeking=!1})),r(z,"input",(()=>{h.seeking=!0;const e=(parseInt(z.value,10)||1)-1;"paged"===h.prefs.mode?(h.current.page=e,H()):_(e);const t=h.current.images.length||1;R(Math.round((e+1)/Math.max(1,t)*100)),$("seek")})));const B=e("#settingsModal");function O(){B&&(B.style.display="none",B.classList.remove("active"),B.setAttribute("aria-hidden","true"))}function W(){["#modeScroll","#modePaged"].forEach((t=>{const r=e(t);r&&r.classList.toggle("active",t==="#mode"+h.prefs.mode.charAt(0).toUpperCase()+h.prefs.mode.slice(1))})),["#dirRTL","#dirLTR"].forEach((t=>{const r=e(t);r&&r.classList.toggle("active",t==="#dir"+h.prefs.dir.toUpperCase())})),["#fitWidth","#fitHeight","#fitNone"].forEach((t=>{const r=e(t);r&&r.classList.toggle("active",t==="#fit"+h.prefs.fit.charAt(0).toUpperCase()+h.prefs.fit.slice(1))}));const t=e("#compactMode");t&&(t.checked=h.prefs.compact)}B&&(B.style.display="none",B.setAttribute("aria-hidden","true"),B.classList.remove("active")),r("#btnSettings","click",(function(){B&&(B.style.display="flex",B.classList.add("active"),B.setAttribute("aria-hidden","false"))})),r("#btnCloseSettings","click",O),r("#settingsModal","click",(e=>{e.target&&"settingsModal"===e.target.id&&O()})),r("#modeScroll","click",(()=>{I("mode","scroll"),I("fit","width"),W()})),r("#modePaged","click",(()=>{I("mode","paged"),W()})),r("#dirRTL","click",(()=>{I("dir","rtl"),W()})),r("#dirLTR","click",(()=>{I("dir","ltr"),W()})),r("#fitWidth","click",(()=>{I("fit","width"),W()})),r("#fitHeight","click",(()=>{I("fit","height"),W()})),r("#fitNone","click",(()=>{I("fit","none"),W()})),r("#btnFitToggle","click",(()=>{const e=w(),t=k(e);!function(e,t){const r=f();r&&(h.fitOverride[r]=h.fitOverride[r]||{},h.fitOverride[r][e]=t)}(e,"width"===t?"height":"height"===t?null:"width"),M(),b(e)})),window.addEventListener("resize",(()=>{h.current.chapter&&(M(),b(w()))})),r("#btnClose","click",(function(){const t=e("#reader");t&&(t.classList.remove("active"),t.setAttribute("aria-hidden","true")),document.body.style.overflow="",x(),"function"==typeof refreshContinueCard&&refreshContinueCard()})),r("#btnReverseOrder","click",(function(){var e,t;h.chaptersReversed=!h.chaptersReversed,e=p,t=h.chaptersReversed,localStorage.setItem(e,String(!!t)),x()})),function(){e("#heroPoster")&&(e("#heroPoster").src=window.meta?.cover||""),e("#heroBg")&&(e("#heroBg").style.backgroundImage=`url('${window.meta?.cover||""}')`),e("#title")&&(e("#title").textContent=window.meta?.title||"Manga"),e("#mainTag")&&(e("#mainTag").textContent=window.meta?.mainTag||""),e("#genres")&&(e("#genres").innerHTML=(window.meta?.genres||[]).map((e=>`<span class="tag">${e}</span>`)).join("")),e("#synopsis")&&(e("#synopsis").textContent=window.meta?.synopsis||""),function(){const e=document.querySelector("#hero");if(!e)return;let t,r=document.querySelector("#favBtn");r||(r=document.createElement("button"),r.id="favBtn",r.className="fav-btn",r.type="button",r.setAttribute("aria-label","Favorito"),r.setAttribute("aria-pressed","false"),e.appendChild(r),r.addEventListener("click",v,{passive:!0})),r.innerHTML='<i class="heart ri-heart-3-line"></i>';try{t=JSON.parse(localStorage.getItem("mreader:favorites"))||[]}catch{t=[]}const n=t.some((e=>e.slug===s));r.classList.toggle("active",n),r.setAttribute("aria-pressed",n?"true":"false")}();const t=e("#favBtn");t&&t.classList.contains("active")&&(t.querySelector(".heart").classList.remove("ri-heart-3-line"),t.querySelector(".heart").classList.add("ri-heart-3-fill"))}(),x(),W()},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",n,{once:!0}):n()}();